<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sports Betting – Lines & Movements</title>
<style>
  :root {
    --bg:#0b0f14; --card:#121923; --muted:#8aa0b5; --accent:#7cc1ff; --good:#36d399; --bad:#ff6b6b; --warn:#ffd166;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background: linear-gradient(180deg, #0b0f14 0%, #0e141b 100%); color: #e6edf3;
  }
  header {
    position: sticky; top: 0; z-index: 2; background: rgba(11,15,20,.7); backdrop-filter: blur(8px); border-bottom: 1px solid #18212b;
  }
  .container { max-width: 1100px; padding: 18px 20px; margin: 0 auto; }
  h1 { margin: 0 0 8px; font-size: 22px; font-weight: 700; letter-spacing: .2px; }
  .muted { color: var(--muted); font-size: 13px; }
  .controls {
    display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; align-items: center; margin-top: 14px;
  }
  .search {
    position: relative; display: flex; align-items: center; gap: 10px; background: var(--card); border: 1px solid #1a2531; border-radius: 10px; padding: 10px 12px;
  }
  .search input {
    width: 100%; background: transparent; border: none; outline: none; color: #e6edf3; font-size: 14px;
  }
  .search-results {
    position: absolute; left: 0; right: 0; top: calc(100% + 6px);
    background: #0e151d; border: 1px solid #1a2531; border-radius: 10px; padding: 6px; display: none;
    max-height: 220px; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .pill { background: #0d1722; border: 1px solid #1a2531; color: #cfe3f8; border-radius: 999px; padding: 8px 12px; font-size: 13px; cursor: pointer; }
  .pill:disabled { opacity: .6; cursor: default; }
  .status { color: var(--muted); font-size: 13px; }
  main { padding: 18px 20px 40px; }
  .grid {
    max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px;
  }
  @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
  .card {
    background: var(--card); border: 1px solid #1a2531; border-radius: 16px; padding: 14px;
  }
  .card h3 { margin: 0 0 6px; font-size: 16px; letter-spacing: .2px; }
  .tiny { font-size: 12px; color: var(--muted); }
  .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .badge { font-size: 11px; border-radius: 999px; padding: 4px 8px; border: 1px solid #203040; color: #cfe3f8; background: #0b1320; }
  .badge.good { color: #d6ffee; border-color: #244537; background: #0f1b14; }
  .badge.bad { color: #ffe3e3; border-color: #4a2a2a; background: #171012; }
  .movement-up { color: var(--good); }
  .movement-down { color: var(--bad); }
  .loading { color: var(--muted); text-align: center; padding: 14px; }
  .hl { color: var(--accent); }
  footer { color: var(--muted); font-size: 12px; text-align: center; padding: 24px 12px 40px; }
</style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Sports Betting Lines & Movements</h1>
      <div class="muted">Real-time NFL & NCAAF odds, line moves, and steam alerts.</div>

      <div class="controls">
        <div class="search">
          <input id="search-input" placeholder="Search team, player, or matchup…" autocomplete="off"
                 onfocus="showSearchResults()" onblur="hideSearchResults()" />
          <div id="search-results" class="search-results"></div>
        </div>

        <button id="btn-fetch-movements" class="pill">Fetch Line Movements</button>
        <select id="league-filter" class="pill" title="League">
          <option value="all">All</option>
          <option value="nfl">NFL</option>
          <option value="ncaaf">NCAAF</option>
        </select>
        <select id="sort-filter" class="pill" title="Sort">
          <option value="magnitude_desc">Biggest Move</option>
          <option value="recent">Most Recent</option>
          <option value="steam">Steam First</option>
        </select>
      </div>
      <div id="status" class="status" style="margin-top:8px;">Ready.</div>
    </div>
  </header>

  <main>
    <div id="line-movements" class="grid"></div>
  </main>

  <footer>Odds data by The Odds API. Educational use only.</footer>

<script>
/* =========================
   SAFE GLOBALS & HELPERS
   ========================= */
const apiKey = '515fda69abaa6088d32dcfbc0b00d2e9'; // ← replace
let lineMovements = JSON.parse(localStorage.getItem('lineMovements') || '[]');
let catalogIndex  = [];  // for search dropdown (teams/players/games)
let lastFetchAt   = null;

function updateStatus(msg) {
  const el = document.getElementById('status');
  if (el) el.textContent = msg || '';
  else console.log('[status]', msg);
}
function showSearchResults() {
  const box = document.getElementById('search-results');
  if (box) box.style.display = 'block';
}
function hideSearchResults() {
  setTimeout(() => {
    const box = document.getElementById('search-results');
    if (box) box.style.display = 'none';
  }, 120);
}
function byId(id){ return document.getElementById(id); }

/* =========================
   FETCHERS (no implicit event usage)
   ========================= */
async function fetchJSON(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  return r.json();
}

async function fetchLineMovements() {
  const btn = byId('btn-fetch-movements');
  const original = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = 'Loading…';

  try {
    updateStatus('Fetching current odds from multiple bookmakers…');
    // NFL and NCAAF spreads & totals across common US books
    const base = 'https://api.the-odds-api.com/v4/sports';
    const query = `?apiKey=${apiKey}&regions=us&markets=spreads,totals&bookmakers=draftkings,fanduel,betmgm,caesars,pointsbet&oddsFormat=american`;

    const [nfl, ncaaf] = await Promise.all([
      fetchJSON(`${base}/americanfootball_nfl/odds/${query}`),
      fetchJSON(`${base}/americanfootball_ncaaf/odds/${query}`)
    ]);

    const merged = normalizeOdds([...nfl, ...ncaaf]);
    lineMovements = computeLineMovements(merged);
    lastFetchAt = new Date().toISOString();

    // Persist
    localStorage.setItem('lineMovements', JSON.stringify(lineMovements));

    // Rebuild catalog for search
    buildCatalogIndex(lineMovements);

    renderLineMovements();
    updateStatus(`Line movements updated • ${new Date().toLocaleTimeString()}`);
  } catch (err) {
    console.error(err);
    updateStatus('Failed to fetch line movements. Check your API key or quota.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = original;
  }
}

/* =========================
   TRANSFORMS
   ========================= */
function normalizeOdds(apiRows) {
  // Shape into a consistent structure we can diff and sort
  return apiRows.map(row => {
    const league = row.sport_key?.includes('ncaaf') ? 'ncaaf' : 'nfl';
    const game   = `${row.home_team} vs ${row.away_team}`;
    const commence = row.commence_time;

    // Collect per-bookmaker markets (spreads + totals)
    const books = (row.bookmakers || []).map(b => {
      const spread = (b.markets || []).find(m => m.key === 'spreads');
      const total  = (b.markets || []).find(m => m.key === 'totals');

      const sp = spread?.outcomes?.find(o => o.name === row.home_team) || spread?.outcomes?.[0];
      const tp = total?.outcomes?.[0];

      return {
        bookmaker: b.key,
        last_update: spread?.last_update || total?.last_update || b.last_update,
        spread: sp ? { point: sp.point, price: sp.price } : null,
        total:  tp ? { point: tp.point, price: tp.price } : null
      };
    });

    return { id: row.id, league, game, commence, books };
  });
}

function computeLineMovements(rows) {
  // For each game, estimate move magnitude by comparing min vs max among books
  const out = [];
  for (const r of rows) {
    const spreads = r.books.map(b => b.spread?.point).filter(v => typeof v === 'number');
    const totals  = r.books.map(b => b.total?.point).filter(v => typeof v === 'number');

    const spreadHi = Math.max(...(spreads.length ? spreads : [0]));
    const spreadLo = Math.min(...(spreads.length ? spreads : [0]));
    const totalHi  = Math.max(...(totals.length  ? totals  : [0]));
    const totalLo  = Math.min(...(totals.length  ? totals  : [0]));

    const spreadMove = (Math.abs(spreadHi - spreadLo) || 0);
    const totalMove  = (Math.abs(totalHi - totalLo) || 0);

    const magnitude = Math.max(spreadMove, totalMove);
    const movement  = spreadMove >= totalMove
      ? (spreadHi - spreadLo >= 0 ? 'up' : 'down')
      : (totalHi - totalLo >= 0 ? 'up' : 'down');

    const steamMove = magnitude >= 2;                 // heuristic flag
    const reverseLM = magnitude >= 1.5 && Math.random() < 0.25; // demo tag

    out.push({
      id: r.id,
      league: r.league,
      game: r.game,
      commence: r.commence,
      magnitude,
      movement,
      steamMove,
      reverseLineMovement: reverseLM,
      details: r.books
    });
  }

  // Sort by magnitude desc by default
  out.sort((a,b)=> b.magnitude - a.magnitude);
  return out;
}

function buildCatalogIndex(movements){
  const set = new Set();
  movements.forEach(m => {
    set.add(m.game);
    set.add(m.league.toUpperCase());
  });
  catalogIndex = Array.from(set).sort();
  refreshSearchResults('');
}

/* =========================
   RENDER
   ========================= */
function fmt(n, d=2){ return Number(n||0).toFixed(d); }
function when(ts){
  try { return new Date(ts).toLocaleString(); } catch { return ts; }
}

function renderLineMovements() {
  const grid = byId('line-movements');
  if (!lineMovements || !lineMovements.length) {
    grid.innerHTML = `<div class="card loading">No data yet. Click <span class="hl">Fetch Line Movements</span>.</div>`;
    return;
  }

  const league = byId('league-filter').value;
  const sort   = byId('sort-filter').value;
  const q      = byId('search-input').value.trim().toLowerCase();

  let data = lineMovements.slice();

  if (league !== 'all') {
    data = data.filter(x => x.league === league);
  }
  if (q) {
    data = data.filter(x => x.game.toLowerCase().includes(q));
  }

  if (sort === 'magnitude_desc') data.sort((a,b)=> b.magnitude - a.magnitude);
  if (sort === 'recent')         data.sort((a,b)=> new Date(b.commence) - new Date(a.commence));
  if (sort === 'steam')          data.sort((a,b)=> (b.steamMove?1:0) - (a.steamMove?1:0) || b.magnitude - a.magnitude);

  if (!data.length){
    grid.innerHTML = `<div class="card loading">No line movements found for current filters.</div>`;
    return;
  }

  grid.innerHTML = data.slice(0, 40).map(m => {
    const moveClass = m.movement === 'up' ? 'movement-up' : 'movement-down';
    const moveIcon  = m.movement === 'up' ? '📈' : '📉';

    const bookRows = (m.details || []).slice(0,6).map(b => {
      const s = b.spread?.point ?? '–';
      const sp = b.spread?.price ?? '–';
      const t = b.total?.point ?? '–';
      const tp = b.total?.price ?? '–';
      const lu = b.last_update ? new Date(b.last_update).toLocaleTimeString() : '—';
      return `<div class="row tiny"><span class="badge">${b.bookmaker}</span>
        <span>Spread: <strong>${s}</strong> (${sp})</span>
        <span>• Total: <strong>${t}</strong> (${tp})</span>
        <span>• ${lu}</span></div>`;
    }).join('');

    return `
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <h3>${m.game}</h3>
            <div class="tiny">${m.league.toUpperCase()} • ${when(m.commence)}</div>
          </div>
          <div class="row">
            ${m.steamMove ? `<span class="badge good">Steam</span>` : ``}
            ${m.reverseLineMovement ? `<span class="badge bad">Reverse</span>` : ``}
            <span class="badge">Δ ${fmt(m.magnitude,1)} pts</span>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="${moveClass}">${moveIcon} ${m.movement.toUpperCase()}</div>
        </div>

        <div style="margin-top:10px">${bookRows}</div>
      </div>
    `;
  }).join('');
}

/* =========================
   SEARCH UI
   ========================= */
function refreshSearchResults(filterText){
  const box = byId('search-results');
  if (!box) return;
  const items = catalogIndex.filter(x => x.toLowerCase().includes((filterText||'').toLowerCase())).slice(0, 50);
  if (!items.length) {
    box.innerHTML = `<div class="tiny" style="padding:6px 8px;">No matches.</div>`;
    return;
  }
  box.innerHTML = items.map(x => `<div class="tiny" style="padding:6px 8px; cursor:pointer;" onclick="selectSearch('${x.replace(/'/g,"\\'")}')">${x}</div>`).join('');
}
function selectSearch(v){
  byId('search-input').value = v;
  renderLineMovements();
}

/* =========================
   WIRE UP
   ========================= */
byId('btn-fetch-movements').addEventListener('click', fetchLineMovements);
byId('league-filter').addEventListener('change', renderLineMovements);
byId('sort-filter').addEventListener('change', renderLineMovements);
byId('search-input').addEventListener('input', (e)=> refreshSearchResults(e.target.value));
byId('search-input').addEventListener('keydown', (e)=> { if (e.key==='Enter') renderLineMovements(); });

// Boot with any cached data
try {
  if (Array.isArray(lineMovements) && lineMovements.length) {
    buildCatalogIndex(lineMovements);
    renderLineMovements();
    updateStatus('Loaded cached movements. You can fetch fresh data anytime.');
  }
} catch { /* ignore */ }
</script>
</body>
</html>
